<main class="min-h-screen bg-black text-gray-200 flex items-center justify-center p-4 font-sans">
  <!-- Port Warning Modal -->
  @if (showPortWarning()) {
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in p-4">
      <div class="bg-gray-900 border border-gray-700 rounded-2xl shadow-2xl shadow-[#e20074]/20 p-8 max-w-md w-full text-center">
        <!-- Icon -->
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-600/20 mb-4">
          <svg class="h-6 w-6 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-white">Aviso Importante</h2>
        <p class="text-gray-400 mt-3 mb-6">
          Os formulários a seguir se conectarão à API na porta <strong>8080</strong>. É de suma importância que a API esteja rodando nesta porta para que o workflow funcione corretamente.
        </p>
        <button (click)="dismissPortWarning()" class="w-full bg-[#e20074] hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-md transition-colors duration-200">
          Entendido, continuar
        </button>
      </div>
    </div>
  }

  <div class="w-full max-w-5xl bg-gray-900/50 border border-gray-800 rounded-2xl shadow-2xl shadow-[#e20074]/10 p-8 transition-all duration-500" [class.blur-sm]="showPortWarning()">
    
    @switch (currentStep()) {
      @case ('login') {
        <div class="animate-fade-in max-w-3xl mx-auto">
          <p class="text-sm font-semibold text-[#e20074]">STEP 1 / 6</p>
          <h1 class="text-3xl font-bold text-white mt-2">Authentication</h1>
          <p class="text-gray-400 mt-2 mb-6">First, let's authenticate. This will give us a token to authorize all future requests.</p>
          <div class="space-y-4">
            <div>
              <label for="loginEmail" class="text-sm text-gray-400 block mb-2">Login Email</label>
              <input id="loginEmail" type="email" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#e20074]" [ngModel]="loginEmail()" (ngModelChange)="loginEmail.set($event)">
            </div>
            <div>
              <label for="loginPassword" class="text-sm text-gray-400 block mb-2">Password</label>
              <input id="loginPassword" type="password" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#e20074]" [ngModel]="loginPassword()" (ngModelChange)="loginPassword.set($event)">
            </div>
          </div>
          <button (click)="handleLogin()" [disabled]="isLoading()" class="w-full mt-6 flex justify-center items-center bg-[#e20074] hover:bg-pink-600 disabled:bg-pink-800 disabled:cursor-not-allowed text-white font-bold py-3 px-4 rounded-md transition-colors duration-200">
            @if (isLoading()) { <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> <span>Authenticating...</span> }
            @else { <span>Get Token &amp; Continue</span> }
          </button>
        </div>
      }
      @case ('tenant') {
        <div class="animate-fade-in max-w-3xl mx-auto">
          <p class="text-sm font-semibold text-[#e20074]">STEP 2 / 6</p>
          <h1 class="text-3xl font-bold text-white mt-2">Create Tenant</h1>
          <p class="text-gray-400 mt-2 mb-6">Now, let's create a Tenant, which represents an isolated organization.</p>
          <div class="space-y-4">
            <div><label for="tenantTradingName" class="text-sm text-gray-400 block mb-2">Trading Name</label><input id="tenantTradingName" type="text" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white" [ngModel]="tenantTradingName()" (ngModelChange)="tenantTradingName.set($event)"></div>
            <div><label for="tenantTaxID" class="text-sm text-gray-400 block mb-2">Tax ID</label><input id="tenantTaxID" type="text" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white" [ngModel]="tenantTaxID()" (ngModelChange)="tenantTaxID.set($event)"></div>
          </div>
          <button (click)="handleCreateTenant()" [disabled]="isLoading()" class="w-full mt-6 flex justify-center items-center bg-[#e20074] hover:bg-pink-600 disabled:bg-pink-800 disabled:cursor-not-allowed text-white font-bold py-3 px-4 rounded-md transition-colors duration-200">
            @if (isLoading()) { <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> <span>Creating Tenant...</span> }
            @else { <span>Create Tenant &amp; Continue</span> }
          </button>
        </div>
      }
      @case ('role') {
        <div class="animate-fade-in max-w-3xl mx-auto">
          <p class="text-sm font-semibold text-[#e20074]">STEP 3 / 6</p>
          <h1 class="text-3xl font-bold text-white mt-2">Create Role</h1>
          <p class="text-gray-400 mt-2 mb-6">Roles define permissions and access levels for users and technicians.</p>
           <div class="space-y-4">
            <div><label for="roleName" class="text-sm text-gray-400 block mb-2">Role Name</label><input id="roleName" type="text" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white" [ngModel]="roleName()" (ngModelChange)="roleName.set($event)"></div>
          </div>
          <button (click)="handleCreateRole()" [disabled]="isLoading()" class="w-full mt-6 flex justify-center items-center bg-[#e20074] hover:bg-pink-600 disabled:bg-pink-800 disabled:cursor-not-allowed text-white font-bold py-3 px-4 rounded-md transition-colors duration-200">
            @if (isLoading()) { <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> <span>Creating Role...</span> }
            @else { <span>Create Role &amp; Continue</span> }
          </button>
        </div>
      }
      @case ('user') {
        <div class="animate-fade-in max-w-3xl mx-auto">
          <p class="text-sm font-semibold text-[#e20074]">STEP 4 / 6</p>
          <h1 class="text-3xl font-bold text-white mt-2">Create User</h1>
          <p class="text-gray-400 mt-2 mb-6">With a tenant and role established, create a User (requester) who will open the ticket.</p>
          <div class="space-y-4">
            <div><label for="userName" class="text-sm text-gray-400 block mb-2">Name</label><input id="userName" type="text" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white" [ngModel]="userName()" (ngModelChange)="userName.set($event)"></div>
            <div><label for="userEmail" class="text-sm text-gray-400 block mb-2">Email</label><input id="userEmail" type="email" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white" [ngModel]="userEmail()" (ngModelChange)="userEmail.set($event)"></div>
            <div><label for="userPass" class="text-sm text-gray-400 block mb-2">Password</label><input id="userPass" type="password" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white" [ngModel]="userPassword()" (ngModelChange)="userPassword.set($event)"></div>
            <div><label for="userPos" class="text-sm text-gray-400 block mb-2">Position</label><input id="userPos" type="text" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white" [ngModel]="userPosition()" (ngModelChange)="userPosition.set($event)"></div>
          
            <!-- Tenant Selection -->
            <div>
              <label class="text-sm text-gray-400 block mb-2">Tenant</label>
              @if (selectedTenant()) {
                <div class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white flex justify-between items-center">
                  <span>{{ selectedTenant()?.tradingName }}</span>
                  <button (click)="selectedTenantId.set(null); tenantSearch.set('')" class="text-xs text-[#e20074] hover:text-pink-400 font-semibold">Change</button>
                </div>
              } @else {
                <div class="relative">
                  <input type="text" placeholder="Search for a tenant..."
                    class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#e20074]"
                    [ngModel]="tenantSearch()"
                    (ngModelChange)="tenantSearch.set($event)"
                    (focus)="showTenantResults.set(true)"
                    (blur)="onTenantBlur()">
                  @if (showTenantResults() && filteredTenants().length > 0) {
                    <div class="absolute z-10 w-full mt-1 bg-gray-800 border border-gray-600 rounded-md shadow-lg max-h-40 overflow-y-auto">
                      @for (tenant of filteredTenants(); track tenant.id) {
                        <div (mousedown)="selectTenant(tenant)" class="px-3 py-2 hover:bg-[#e20074]/20 cursor-pointer">
                          {{ tenant.tradingName }}
                        </div>
                      }
                    </div>
                  }
                </div>
              }
            </div>

            <!-- Role Selection -->
            <div>
              <label class="text-sm text-gray-400 block mb-2">Role</label>
               @if (selectedRole()) {
                <div class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white flex justify-between items-center">
                  <span>{{ selectedRole()?.name }}</span>
                  <button (click)="selectedRoleId.set(null); roleSearch.set('')" class="text-xs text-[#e20074] hover:text-pink-400 font-semibold">Change</button>
                </div>
              } @else {
                <div class="relative">
                  <input type="text" placeholder="Search for a role..."
                    class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#e20074]"
                    [ngModel]="roleSearch()"
                    (ngModelChange)="roleSearch.set($event)"
                    (focus)="showRoleResults.set(true)"
                    (blur)="onRoleBlur()">
                  @if (showRoleResults() && filteredRoles().length > 0) {
                    <div class="absolute z-10 w-full mt-1 bg-gray-800 border border-gray-600 rounded-md shadow-lg max-h-40 overflow-y-auto">
                      @for (role of filteredRoles(); track role.id) {
                        <div (mousedown)="selectRole(role)" class="px-3 py-2 hover:bg-[#e20074]/20 cursor-pointer">
                          {{ role.name }}
                        </div>
                      }
                    </div>
                  }
                </div>
              }
            </div>
          </div>
          <button (click)="handleCreateUser()" [disabled]="isLoading() || !selectedTenantId() || !selectedRoleId()" class="w-full mt-6 flex justify-center items-center bg-[#e20074] hover:bg-pink-600 disabled:bg-pink-800 disabled:cursor-not-allowed text-white font-bold py-3 px-4 rounded-md transition-colors duration-200">
            @if (isLoading()) { <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> <span>Creating User...</span> }
            @else { <span>Create User &amp; Continue</span> }
          </button>
        </div>
      }
      @case ('sla') {
        <div class="animate-fade-in max-w-3xl mx-auto">
          <p class="text-sm font-semibold text-[#e20074]">STEP 5 / 6</p>
          <h1 class="text-3xl font-bold text-white mt-2">Create SLA Policy</h1>
          <p class="text-gray-400 mt-2 mb-6">Define a Service Level Agreement (SLA) policy for response and resolution times.</p>
           <div class="space-y-6">
              <div>
                <h3 class="text-lg font-semibold text-white mb-3 border-b border-gray-700 pb-2">SLA Details</h3>
                <div class="space-y-4">
                  <!-- Tenant Selection -->
                  <div>
                    <label class="text-sm text-gray-400 block mb-2">Tenant</label>
                    @if (slaSelectedTenant()) {
                      <div class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white flex justify-between items-center">
                        <span>{{ slaSelectedTenant()?.tradingName }}</span>
                        <button (click)="slaSelectedTenantId.set(null); slaTenantSearch.set('')" class="text-xs text-[#e20074] hover:text-pink-400 font-semibold">Change</button>
                      </div>
                    } @else {
                      <div class="relative">
                        <input type="text" placeholder="Search for a tenant..."
                          class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#e20074]"
                          [ngModel]="slaTenantSearch()"
                          (ngModelChange)="slaTenantSearch.set($event)"
                          (focus)="showSlaTenantResults.set(true)"
                          (blur)="onSlaTenantBlur()">
                        @if (showSlaTenantResults() && slaFilteredTenants().length > 0) {
                          <div class="absolute z-10 w-full mt-1 bg-gray-800 border border-gray-600 rounded-md shadow-lg max-h-40 overflow-y-auto">
                            @for (tenant of slaFilteredTenants(); track tenant.id) {
                              <div (mousedown)="selectSlaTenant(tenant)" class="px-3 py-2 hover:bg-[#e20074]/20 cursor-pointer">
                                {{ tenant.tradingName }}
                              </div>
                            }
                          </div>
                        }
                      </div>
                    }
                  </div>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label for="slaName" class="text-sm text-gray-400 block mb-2">Policy Name</label><input id="slaName" type="text" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white" [ngModel]="slaName()" (ngModelChange)="slaName.set($event)"></div>
                    <div><label for="slaPrioName" class="text-sm text-gray-400 block mb-2">Priority Name</label><input id="slaPrioName" type="text" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white" [ngModel]="slaPriorityName()" (ngModelChange)="slaPriorityName.set($event)"></div>
                    <div><label for="slaRespTime" class="text-sm text-gray-400 block mb-2">Response Time (mins)</label><input id="slaRespTime" type="number" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white" [ngModel]="slaResponseTime()" (ngModelChange)="slaResponseTime.set($event)"></div>
                    <div><label for="slaResTime" class="text-sm text-gray-400 block mb-2">Resolution Time (mins)</label><input id="slaResTime" type="number" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white" [ngModel]="slaResolutionTime()" (ngModelChange)="slaResolutionTime.set($event)"></div>
                    <div class="flex items-center space-x-4 pt-2 md:col-span-2">
                      <div class="flex items-center"><input id="slaActive" type="checkbox" class="h-4 w-4 rounded bg-gray-700 text-[#e20074] focus:ring-[#e20074]" [ngModel]="slaIsActive()" (ngModelChange)="slaIsActive.set($event)"><label for="slaActive" class="ml-2 text-sm text-gray-300">Active</label></div>
                      <div class="flex items-center"><input id="slaOpHours" type="checkbox" class="h-4 w-4 rounded bg-gray-700 text-[#e20074] focus:ring-[#e20074]" [ngModel]="slaOperationalHoursOnly()" (ngModelChange)="slaOperationalHoursOnly.set($event)"><label for="slaOpHours" class="ml-2 text-sm text-gray-300">Operational Hours Only</label></div>
                    </div>
                  </div>
                </div>
              </div>
               <div>
                <h3 class="text-lg font-semibold text-white mb-3 border-b border-gray-700 pb-2">Category Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div><label for="slaCatName" class="text-sm text-gray-400 block mb-2">Category Name</label><input id="slaCatName" type="text" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white" [ngModel]="slaCategoryName()" (ngModelChange)="slaCategoryName.set($event)"></div>
                  <div><label for="slaCatDesc" class="text-sm text-gray-400 block mb-2">Category Description</label><input id="slaCatDesc" type="text" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white" [ngModel]="slaCategoryDesc()" (ngModelChange)="slaCategoryDesc.set($event)"></div>
                </div>
              </div>
           </div>
          <button (click)="handleCreateSla()" [disabled]="isLoading() || !slaSelectedTenantId()" class="w-full mt-6 flex justify-center items-center bg-[#e20074] hover:bg-pink-600 disabled:bg-pink-800 disabled:cursor-not-allowed text-white font-bold py-3 px-4 rounded-md transition-colors duration-200">
            @if (isLoading()) { <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> <span>Creating SLA...</span> }
            @else { <span>Create SLA &amp; Continue</span> }
          </button>
        </div>
      }
      @case ('ticket') {
        <div class="animate-fade-in max-w-3xl mx-auto">
          <p class="text-sm font-semibold text-[#e20074]">STEP 6 / 6</p>
          <h1 class="text-3xl font-bold text-white mt-2">Create Ticket</h1>
          <p class="text-gray-400 mt-2 mb-6">Finally, create a support ticket using the resources we've just set up.</p>
           <div class="space-y-4">
            <div><label for="ticketTitle" class="text-sm text-gray-400 block mb-2">Title</label><input id="ticketTitle" type="text" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white" [ngModel]="ticketTitle()" (ngModelChange)="ticketTitle.set($event)"></div>
            <div><label for="ticketDesc" class="text-sm text-gray-400 block mb-2">Description</label><textarea id="ticketDesc" class="w-full h-24 bg-gray-900 border border-gray-700 rounded-md p-3 text-white focus:outline-none focus:ring-2 focus:ring-[#e20074]" [ngModel]="ticketDescription()" (ngModelChange)="ticketDescription.set($event)"></textarea></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="ticketType" class="text-sm text-gray-400 block mb-2">Ticket Type</label>
                <select id="ticketType" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-[#e20074]" [ngModel]="ticketType()" (ngModelChange)="ticketType.set($event)">
                  <option>INCIDENT</option>
                  <option>REQUEST</option>
                  <option>PROBLEM</option>
                </select>
              </div>
              <div><label for="ticketDueDate" class="text-sm text-gray-400 block mb-2">Resolution Due Date</label><input id="ticketDueDate" type="datetime-local" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white" [ngModel]="ticketDueDate()" (ngModelChange)="ticketDueDate.set($event)"></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-2">
              <!-- Tenant -->
              <div>
                <label class="text-sm text-gray-400 block mb-2">Tenant</label>
                @if (selectedTicketTenant()) {
                  <div class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white flex justify-between items-center">
                    <span>{{ selectedTicketTenant()?.tradingName }}</span>
                    <button (click)="ticketTenantId.set(null); ticketTenantSearch.set('')" class="text-xs text-[#e20074] hover:text-pink-400 font-semibold">Change</button>
                  </div>
                } @else {
                  <div class="relative">
                    <input type="text" placeholder="Search for a tenant..."
                      class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#e20074]"
                      [ngModel]="ticketTenantSearch()"
                      (ngModelChange)="ticketTenantSearch.set($event)"
                      (focus)="showTicketTenantResults.set(true)"
                      (blur)="onTicketTenantBlur()">
                    @if (showTicketTenantResults() && filteredTicketTenants().length > 0) {
                      <div class="absolute z-10 w-full mt-1 bg-gray-800 border border-gray-600 rounded-md shadow-lg max-h-40 overflow-y-auto">
                        @for (tenant of filteredTicketTenants(); track tenant.id) {
                          <div (mousedown)="selectTicketTenant(tenant)" class="px-3 py-2 hover:bg-[#e20074]/20 cursor-pointer">
                            {{ tenant.tradingName }}
                          </div>
                        }
                      </div>
                    }
                  </div>
                }
              </div>

              <!-- Requester -->
              <div>
                <label class="text-sm text-gray-400 block mb-2">Requester</label>
                @if (selectedTicketRequester()) {
                  <div class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white flex justify-between items-center">
                    <span>{{ selectedTicketRequester()?.name }}</span>
                    <button (click)="ticketRequesterId.set(null); ticketRequesterSearch.set('')" class="text-xs text-[#e20074] hover:text-pink-400 font-semibold">Change</button>
                  </div>
                } @else {
                  <div class="relative">
                    <input type="text" placeholder="Search for a user..."
                      class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#e20074]"
                      [ngModel]="ticketRequesterSearch()"
                      (ngModelChange)="ticketRequesterSearch.set($event)"
                      (focus)="showTicketRequesterResults.set(true)"
                      (blur)="onTicketRequesterBlur()">
                    @if (showTicketRequesterResults() && filteredTicketRequesters().length > 0) {
                      <div class="absolute z-10 w-full mt-1 bg-gray-800 border border-gray-600 rounded-md shadow-lg max-h-40 overflow-y-auto">
                        @for (user of filteredTicketRequesters(); track user.id) {
                          <div (mousedown)="selectTicketRequester(user)" class="px-3 py-2 hover:bg-[#e20074]/20 cursor-pointer">
                            {{ user.name }}
                          </div>
                        }
                      </div>
                    }
                  </div>
                }
              </div>

              <!-- Technician -->
              <div>
                <label class="text-sm text-gray-400 block mb-2">Technician</label>
                @if (selectedTicketTechnician()) {
                  <div class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white flex justify-between items-center">
                    <span>{{ selectedTicketTechnician()?.name }}</span>
                    <button (click)="ticketTechnicianId.set(null); ticketTechnicianSearch.set('')" class="text-xs text-[#e20074] hover:text-pink-400 font-semibold">Change</button>
                  </div>
                } @else {
                  <div class="relative">
                    <input type="text" placeholder="Search for a technician..."
                      class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#e20074]"
                      [ngModel]="ticketTechnicianSearch()"
                      (ngModelChange)="ticketTechnicianSearch.set($event)"
                      (focus)="showTicketTechnicianResults.set(true)"
                      (blur)="onTicketTechnicianBlur()">
                    @if (showTicketTechnicianResults() && filteredTicketTechnicians().length > 0) {
                      <div class="absolute z-10 w-full mt-1 bg-gray-800 border border-gray-600 rounded-md shadow-lg max-h-40 overflow-y-auto">
                        @for (technician of filteredTicketTechnicians(); track technician.id) {
                          <div (mousedown)="selectTicketTechnician(technician)" class="px-3 py-2 hover:bg-[#e20074]/20 cursor-pointer">
                            {{ technician.name }}
                          </div>
                        }
                      </div>
                    }
                  </div>
                }
              </div>

              <!-- Category -->
              <div>
                <label class="text-sm text-gray-400 block mb-2">Category</label>
                @if (selectedTicketCategory()) {
                  <div class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white flex justify-between items-center">
                    <span>{{ selectedTicketCategory()?.name }}</span>
                    <button (click)="ticketCategoryId.set(null); ticketCategorySearch.set('')" class="text-xs text-[#e20074] hover:text-pink-400 font-semibold">Change</button>
                  </div>
                } @else {
                  <div class="relative">
                    <input type="text" placeholder="Search for a category..."
                      class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#e20074]"
                      [ngModel]="ticketCategorySearch()"
                      (ngModelChange)="ticketCategorySearch.set($event)"
                      (focus)="showTicketCategoryResults.set(true)"
                      (blur)="onTicketCategoryBlur()">
                    @if (showTicketCategoryResults() && filteredTicketCategories().length > 0) {
                      <div class="absolute z-10 w-full mt-1 bg-gray-800 border border-gray-600 rounded-md shadow-lg max-h-40 overflow-y-auto">
                        @for (category of filteredTicketCategories(); track category.id) {
                          <div (mousedown)="selectTicketCategory(category)" class="px-3 py-2 hover:bg-[#e20074]/20 cursor-pointer">
                            {{ category.name }}
                          </div>
                        }
                      </div>
                    }
                  </div>
                }
              </div>

              <!-- Priority -->
              <div>
                <label class="text-sm text-gray-400 block mb-2">Priority</label>
                @if (selectedTicketPriority()) {
                  <div class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white flex justify-between items-center">
                    <span>{{ selectedTicketPriority()?.name }}</span>
                    <button (click)="ticketPriorityId.set(null); ticketPrioritySearch.set('')" class="text-xs text-[#e20074] hover:text-pink-400 font-semibold">Change</button>
                  </div>
                } @else {
                  <div class="relative">
                    <input type="text" placeholder="Search for a priority..."
                      class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#e20074]"
                      [ngModel]="ticketPrioritySearch()"
                      (ngModelChange)="ticketPrioritySearch.set($event)"
                      (focus)="showTicketPriorityResults.set(true)"
                      (blur)="onTicketPriorityBlur()">
                    @if (showTicketPriorityResults() && filteredTicketPriorities().length > 0) {
                      <div class="absolute z-10 w-full mt-1 bg-gray-800 border border-gray-600 rounded-md shadow-lg max-h-40 overflow-y-auto">
                        @for (priority of filteredTicketPriorities(); track priority.id) {
                          <div (mousedown)="selectTicketPriority(priority)" class="px-3 py-2 hover:bg-[#e20074]/20 cursor-pointer">
                            {{ priority.name }}
                          </div>
                        }
                      </div>
                    }
                  </div>
                }
              </div>
            </div>
          </div>
          <button (click)="handleCreateTicket()" [disabled]="isLoading() || !ticketTenantId() || !ticketRequesterId() || !ticketTechnicianId() || !ticketCategoryId() || !ticketPriorityId()" class="w-full mt-6 flex justify-center items-center bg-[#e20074] hover:bg-pink-600 disabled:bg-pink-800 disabled:cursor-not-allowed text-white font-bold py-3 px-4 rounded-md transition-colors duration-200">
            @if (isLoading()) { <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> <span>Creating Ticket...</span> }
            @else { <span>Finish Workflow</span> }
          </button>
        </div>
      }
       @case ('complete') {
        <div class="animate-fade-in text-center">
          <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-600/20 mb-4">
            <svg class="h-8 w-8 text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <h1 class="text-3xl font-bold text-white mt-2">Workflow Complete!</h1>
          <p class="text-gray-400 mt-2 mb-6">You have successfully created a new ticket. Below are the details.</p>
          
          @if (lastResponse()?.body; as ticket) {
            <!-- Detailed Ticket View -->
            <div class="mt-8 bg-gray-900 border border-gray-700 rounded-2xl shadow-2xl shadow-[#e20074]/20 text-left transition-all duration-300 mx-auto">
              <!-- Header -->
              <div class="p-6 border-b border-gray-800 bg-gray-900/50 rounded-t-2xl">
                <div class="flex justify-between items-start">
                  <div>
                    <p class="text-sm text-[#e20074] font-semibold tracking-wider">{{ ticket.ticketType || 'TICKET' }}</p>
                    <h2 class="text-2xl font-bold text-white mt-1">{{ ticket.title }}</h2>
                  </div>
                  <div class="text-right flex-shrink-0 ml-4">
                    <p class="font-mono text-sm bg-gray-800 text-gray-300 px-3 py-1 rounded-md">#{{ ticket.id }}</p>
                    @if (ticket.status === 'OPEN') {
                      <p class="mt-2 text-xs font-semibold uppercase tracking-wider bg-green-600/20 text-green-300 px-2 py-1 rounded-full inline-block">{{ ticket.status }}</p>
                    } @else {
                      <p class="mt-2 text-xs font-semibold uppercase tracking-wider bg-yellow-600/20 text-yellow-300 px-2 py-1 rounded-full inline-block">{{ ticket.status || 'UNKNOWN' }}</p>
                    }
                  </div>
                </div>
              </div>

              <!-- Body -->
              <div class="p-6 space-y-8">
                <!-- Description & AI Analysis -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <!-- User Description -->
                  <div>
                    <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                      Problem Description
                    </h3>
                    <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4 text-gray-300 text-sm whitespace-pre-wrap min-h-[150px]">
                      {{ ticket.description }}
                    </div>
                  </div>
                  <!-- AI Analysis -->
                  <div>
                    <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-[#e20074]" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                      AI Analysis
                    </h3>
                    <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4 text-gray-300 text-sm whitespace-pre-wrap min-h-[150px]">
                      {{ ticket.translatedDescription || 'No analysis available.' }}
                    </div>
                  </div>
                </div>
                
                <div class="border-t border-gray-800"></div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 text-sm">
                  <div class="space-y-4">
                    <h4 class="font-semibold text-white text-base">Requester</h4>
                    <div><p class="text-gray-400">Name</p><p class="text-gray-200 truncate">{{ ticket.requester?.name || 'N/A' }}</p></div>
                    <div><p class="text-gray-400">Email</p><p class="text-gray-200 truncate">{{ ticket.requester?.email || 'N/A' }}</p></div>
                    <div><p class="text-gray-400">Position</p><p class="text-gray-200 truncate">{{ ticket.requester?.position || 'N/A' }}</p></div>
                  </div>
                  
                  <div class="space-y-4">
                    <h4 class="font-semibold text-white text-base">Assignment & Category</h4>
                    <div><p class="text-gray-400">Tenant</p><p class="text-gray-200 truncate">{{ ticket.tenant?.tradingName || 'N/A' }}</p></div>
                    <div><p class="text-gray-400">Technician</p><p class="text-gray-200 truncate">{{ ticket.technician?.name || 'Unassigned' }}</p></div>
                    <div><p class="text-gray-400">Category</p><p class="text-gray-200 truncate">{{ ticket.category?.name || 'N/A' }}</p></div>
                  </div>

                  <div class="space-y-4">
                    <h4 class="font-semibold text-white text-base">Timeline & SLA</h4>
                    <div><p class="text-gray-400">Priority</p><p class="text-gray-200 truncate">{{ ticket.priority?.name || 'N/A' }}</p></div>
                    <div><p class="text-gray-400">Created At</p><p class="text-gray-200 font-mono">{{ ticket.createdAt | date:'short' }}</p></div>
                    <div><p class="text-gray-400">Resolution Due</p><p class="text-gray-200 font-mono">{{ ticket.resolutionDueDate | date:'short' }}</p></div>
                  </div>
                </div>
              </div>
            </div>

          } @else {
            <!-- Fallback for created IDs if ticket object is not available for some reason -->
            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4 text-left font-mono text-sm text-gray-300 space-y-2 max-w-2xl mx-auto">
              <p><span class="text-[#e20074] font-semibold">authToken:</span> "{{ authToken()?.substring(0, 30) }}..."</p>
              <p><span class="text-[#e20074] font-semibold">tenantId:</span> {{ createdIds().tenantId }}</p>
              <p><span class="text-[#e20074] font-semibold">roleId:</span> {{ createdIds().roleId }}</p>
              <p><span class="text-[#e20074] font-semibold">userId:</span> {{ createdIds().userId }}</p>
              <p><span class="text-[#e20074] font-semibold">slaPolicyId:</span> {{ createdIds().slaPolicyId }}</p>
              <p><span class="text-[#e20074] font-semibold">ticketId:</span> {{ createdIds().ticketId }}</p>
            </div>
          }

          <p class="text-gray-500 mt-8 text-sm">You can now use the auth token to interact with the API further.</p>

          <button (click)="startOver()" class="mt-6 bg-[#e20074] hover:bg-pink-600 text-white font-bold py-2 px-6 rounded-md transition-colors duration-200">
            Start Over
          </button>
        </div>
      }
    }

    <!-- Shared Error and Response Display -->
    @if (error()) {
      <div class="mt-6 bg-red-900/50 border border-red-700 text-red-300 px-4 py-3 rounded-md animate-fade-in max-w-3xl mx-auto">
        <strong class="font-bold">Error:</strong>
        <span class="block sm:inline ml-2">{{ error() }}</span>
      </div>
    }

    @if (lastResponse() && currentStep() !== 'complete') {
       @if (lastResponse(); as res) {
        <div class="mt-6 animate-fade-in max-w-3xl mx-auto">
          <h3 class="text-lg font-semibold text-white mb-2">Last Successful Response (Status: <span [class.text-green-400]="res.status >= 200 && res.status < 300" [class.text-yellow-400]="res.status >= 400">{{res.status}}</span>)</h3>
          <pre class="w-full max-h-48 bg-gray-900 border border-gray-700 rounded-md p-3 text-white font-mono text-xs overflow-auto"><code>{{ formatResponseBody(res.body) }}</code></pre>
        </div>
       }
    }
  </div>
</main>